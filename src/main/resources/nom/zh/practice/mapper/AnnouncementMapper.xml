<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!--suppress ALL -->
<mapper namespace="nom.zh.practice.mapper.AnnouncementMapper">

    <!-- 公告列表封装where语句 -->
    <sql id="GongGaoWhere">
        <where>
            n.DEL = 1
            <if test="bt != null and bt != ''">
                AND n.BT like CONCAT('%', #{bt}, '%')
            </if>
            <if test="cnm != null and cnm != ''">
                AND s.NM like CONCAT('%', #{cnm}, '%')
            </if>
            <if test="vdt != null and vdt != ''">
                AND n.INDT like CONCAT(#{vdt} , '%')
            </if>
        </where>
    </sql>

    <!-- 公告列表分页查询 -->
    <select id="queryGongGaoPage" resultType="java.util.Map">
        SELECT
        n.NID,
        n.BT,
        s.NM,
        DATE_FORMAT(n.INDT,'%Y-%m-%d %T') INDT,
        COUNT(R.NID) COUNT
        FROM
        notice n
        INNER JOIN users s ON n.INUID = s.UID
        LEFT JOIN not_read R ON n.NID = R.NID
        <include refid="GongGaoWhere"></include>
        GROUP BY
        n.NID
        ORDER BY INDT DESC
    </select>


    <!--发公告-->
    <insert id="doSendMes">
        insert into NOTICE
        <trim prefix="(" suffix=")" suffixOverrides=",">
            NID,
            BT,
            NR,
            INUID,
            INDT,
            INIP,
            DEL
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            #{nid},
            #{bt},
            #{nr},
            #{inId},
            DATE_FORMAT(#{inDt},'%Y-%m-%d %T'),
            #{inIp},
            #{del}
        </trim>
    </insert>


    <!-- 通过Nid进行查询 -->
    <select id="queryGongGaoByNid" resultType="java.util.Map">
        SELECT
            n.NID,
            n.BT,
            n.NR
        FROM
            notice n
        WHERE
            n.NID = #{nid}
    </select>

    <!-- 查看是否已读 -->
    <select id="queryIfRead" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM
            NOT_READ
        WHERE
            NID = #{nid}
            AND
            RUID = #{uid}
    </select>


    <!--标记为已读-->
    <insert id="updateRead">
        insert into NOT_READ
        <trim prefix="(" suffix=")" suffixOverrides=",">
            RID,
            RUID,
            NID,
            RIP,
            RDT
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            #{rid},
            #{uid},
            #{nid},
            #{rip},
            DATE_FORMAT(#{rdt},'%Y-%m-%d %T'),
        </trim>
    </insert>

    <!-- 删除公告 -->
    <update id="updateDel">
        UPDATE notice
        SET
            DEL    = 2,
            DELUID = #{deluid},
            DELDT  = #{deldt},
            DELIP  = #{delip}
        WHERE
            NID = #{nid}
    </update>


</mapper>