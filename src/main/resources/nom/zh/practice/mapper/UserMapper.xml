<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!--suppress ALL -->
<mapper namespace="nom.zh.practice.mapper.UserMapper">
    <!-- 分页查询 -->
    <select id="selectPage" resultType="java.util.Map">
        SELECT
        UID,
        `USER`,
        NM,
        SEX,
        DATE_FORMAT(BIRTHDAY,'%Y-%m-%d') AS BIRTHDAY,
        `TYPE`,
        DATE_FORMAT(UPDT,'%Y-%m-%d %T') AS UPDT,
        DEL
        FROM
        USERS
        WHERE 1 = 1
        <if test="type != null and type != ''">
            AND `TYPE` = #{type}
        </if>
        <if test="nm != null and nm != ''">
            AND NM LIKE CONCAT('%', #{nm}, '%')
        </if>
        <if test="del != null and del != ''">
            AND DEL = #{del}
        </if>
        <if test="sex != null and sex != ''">
            AND SEX = #{sex}
        </if>
        ORDER BY `TYPE` ASC,DEL ASC,INDT ASC

    </select>

    <!-- 添加用户 -->
    <insert id="insertUser">
        INSERT INTO USERS (
            UID,
            `USER`,
            PAS,
            NM,
            SEX,
            BIRTHDAY,
            `TYPE`,
            INUID,
            INDT,
            INIP,
            UPUID,
            UPDT,
            UPIP,
            DEL
        )
        VALUES (#{uid}, #{user}, #{pas}, #{nm}, #{sex}, DATE_FORMAT(#{birthday}, '%Y-%m-%d'), #{type}, #{douid},
                        DATE_FORMAT(#{dt}, '%Y-%m-%d %T'), #{ip}, #{douid}, DATE_FORMAT(#{dt}, '%Y-%m-%d %T'), #{ip},
                #{del})
    </insert>

    <!-- 通过UID查询用户的所有信息-->
    <select id="queryUserByUid" resultType="java.util.Map">
        SELECT *
        FROM
            USERS
        WHERE
            UID = #{uid}
    </select>

    <update id="updateUser">
        UPDATE USERS
        SET
            `TYPE` = #{type},
            DEL    = #{del},
            UPUID  = #{upUid},
            UPDT   = DATE_FORMAT(#{upDt}, '%Y-%m-%d %T'),
            UPIP   = #{upIp}
        WHERE
            UID = #{uid}
    </update>


    <!-- 查询14天之内过生日的人-->
    <select id="queryBirUser" resultType="java.util.Map">
        SELECT
            a.NM,
            a.days DAYS
        FROM
            (
                SELECT
                    t.NM,
                    t.birthday,
                    CASE
                    WHEN t.b >= 0
                        THEN
                            t.b
                    ELSE
                        t.a
                    END days
                FROM
                    (
                        SELECT
                            NM,
                            BIRTHDAY,
                            DATEDIFF(
                                    CONCAT(
                                            DATE_FORMAT(NOW(), '%Y') + 1,
                                            DATE_FORMAT(BIRTHDAY, '-%m-%d')
                                    ),
                                    NOW()
                            ) a,
                            DATEDIFF(
                                    CONCAT(
                                            DATE_FORMAT(NOW(), '%Y'),
                                            DATE_FORMAT(BIRTHDAY, '-%m-%d')
                                    ),
                                    NOW()
                            ) b
                        FROM
                            users
                    ) t
                ORDER BY days
            ) a
        WHERE
            a.days BETWEEN 0
            AND 13;
    </select>

    <!-- 查询14天之内过生日的总数-->
    <select id="queryBirCount" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM users
        WHERE
            /*不跨年的查询*/
            DATEDIFF(CAST(CONCAT(YEAR(NOW()), DATE_FORMAT(BIRTHDAY, '-%m-%d')) AS DATE),
                     CAST(DATE_FORMAT(NOW(), '%y-%m-%d') AS DATE)) BETWEEN 0 AND 13
            OR /* or后面的是捎带解决跨年问题*/
            DATEDIFF(CAST(CONCAT(YEAR(NOW()) + 1, DATE_FORMAT(BIRTHDAY, '-%m-%d')) AS DATE),
                     CAST(DATE_FORMAT(NOW(), '%y-%m-%d') AS DATE)) BETWEEN 0 AND 13;
    </select>

    <!-- 重置密码 -->
    <update id="doRePas">
        UPDATE users
        SET
            PAS   = #{pas},
            UPUID = #{upuid},
            UPDT  = #{updt},
            UPIP  = #{upip}
        WHERE
            UID = #{uid}
    </update>


    <!-- 查询登录人的权限-->
    <select id="queryPop" resultType="java.util.Map">
        SELECT
            P.PID,
            p.PNAME,
            p.LINK
        FROM
            users u
            LEFT JOIN users_pop up ON u.UID = up.UID
            LEFT JOIN pop p ON p.PID = up.PID
        WHERE
            u.UID = #{uid}
        ORDER BY P.SORT
    </select>


    <!-- 添加权限 -->
    <insert id="editPopByUid">
        INSERT INTO users_pop (
            ID,
            UID,
            PID
        )
        VALUES (#{id}, #{uid}, #{pid})
    </insert>

    <!-- 删除权限 -->
    <delete id="delPopByUid">
        DELETE
        FROM
            users_pop
        WHERE
            UID = #{uid}
    </delete>


    <!-- 判断是否有此权限-->
    <select id="checkPop" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM
            users_pop
        WHERE
            UID = #{uid}
            AND
            PID = #{pid}
    </select>

    <!--查看用户名是否存在-->
    <select id="queryUser" resultType="java.util.Map">
        SELECT `USER`
        FROM users
        WHERE `USER` = #{user}
    </select>

</mapper>
